{{#study}}
<form id="model-form">
  <div class="form-group">
    <label for="model-formfull">Full formula:</label>
    <input id="model-formfull" class="form-control" name="formfull" type="text"
           value="{{form}}" />
  </div>
  <div class="form-group">
    <label for="model-formred">Reduced formula:</label>
    <input id="model-formred" class="form-control" name="formred" type="text"
           value="{{formred}}" />
  </div>

  <button id="model-submit" type="submit" class="btn btn-primary active">
    <span class="label">Generate StatMap</span>
    <span class="spinner spinner-border spinner-border-sm" role="status"></span>
    <span class="running">Running...</span>
  </button>
  <pre id="statmap-log" class="d-none mt-3 mb-3">
  </pre>
</form>
{{#plots}}
<img src="{{{.}}}" />
{{/plots}}
{{/study}}

<script type="text/javascript">
  function checkStatMap() {
    $.ajax({
      type: 'GET',
      url: '/statMap?token={{token}}',
      contentType: 'application/json',
      success: function(result) {
        let log = $('#statmap-log')
        log.text(result.log).removeClass('d-none');

        if (result.status == 'running') {
          setTimeout(checkStatMap, 3000);
        } else if (result.status == 'finished') {
          log.addClass('d-none');
          $('ul.nav a.nav-link').removeClass('active')
          $('#statmap-link').removeClass('disabled').addClass('active');
          $('div.tab-content div.tab-pane').removeClass('active');
          $('#statmap-content').html(result.html).addClass('active');
          $('#model-submit').prop('disabled', false).
            removeClass('running').addClass('active');
        }
      },
      error: function(xhr) {
        console.log('unknown error:', xhr);
        $('#model-submit').prop('disabled', false).removeClass('running');
      }
    });
  }

  $('#model-form').submit(function(event) {
    event.preventDefault();

    let form = $(this);
    let data = {
      'token': '{{token}}',
      'formfull': form.find('input[name="formfull"]').val(),
      'formred':  form.find('input[name="formred"]').val()
    };

    $('#model-submit').prop('disabled', true).
      removeClass('active').addClass('running');

    $.ajax({
      type: 'POST',
      url: '/createStatMap?token={{token}}',
      data: JSON.stringify(data),
      contentType: 'application/json',
      success: function(result) {
        setTimeout(checkStatMap, 3000);
      },
      error: function(xhr) {
        console.log('unknown error:', xhr);
      }
    });
  });
</script>
